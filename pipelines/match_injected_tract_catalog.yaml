description: Match tract-level injected_deepCoadd_catalog datasets to injected_objectTable_tract datasets.
parameters:
  bands_injected: ["u", "g", "r", "i", "z", "y"]
  flux_algorithms: ["cModel", "gaap1p0", "gaap3p0", "kron", "psf", "sersic"]
  source_type_column: "source_type"
tasks:
  consolidate_injected_catalogs:
    class: lsst.source.injection.utils.ConsolidateInjectedCatalogsTask
  match_object_to_injected:
    class: lsst.pipe.tasks.match_tract_catalog.MatchTractCatalogTask
    config:
      connections.name_input_cat_ref: injected_deepCoadd_catalog_tract
      connections.name_input_cat_target: injected_objectTable_tract
      match_tract_catalog.column_ref_order: i_mag
      match_tract_catalog.columns_ref_meas: ["ra", "dec"]
      match_tract_catalog.columns_target_meas: ["coord_ra", "coord_dec"]
      match_tract_catalog.columns_target_err: ["coord_raErr", "coord_decErr"]
      match_tract_catalog.columns_ref_copy: ["injected_id"]
      match_tract_catalog.columns_target_copy: ["objectId"]
      match_tract_catalog.columns_ref_select_true: ["injected_isPrimary"]
      match_tract_catalog.columns_ref_select_false: ["injection_flag"]
      match_tract_catalog.columns_target_select_true: ["detect_isPrimary"]
      match_tract_catalog.columns_target_select_false: ["merge_peak_sky"]
      match_tract_catalog.match_n_finite_min: 2
      match_tract_catalog.order_ascending: true
      python: |
        from lsst.pipe.tasks.match_tract_catalog_probabilistic import MatchTractCatalogProbabilisticTask

        config.match_tract_catalog.retarget(MatchTractCatalogProbabilisticTask)
  compare_object_to_injected:
    class: lsst.pipe.tasks.diff_matched_tract_catalog.DiffMatchedTractCatalogTask
    config:
      connections.name_input_cat_ref: injected_deepCoadd_catalog_tract
      connections.name_input_cat_target: injected_objectTable_tract
      column_matched_prefix_ref: "ref_"
      columns_target_coord_err: ["coord_raErr", "coord_decErr"]
      include_unmatched: true
      python: |
        columns_ref_mag_to_nJy = {}
        columns_ref_copy = [
          "injected_id", parameters.source_type_column, "injection_flag",
          "injected_isPatchInner", "injected_isTractInner", "injected_isPrimary",
        ]
        columns_target_copy = [
          "objectId", "patch", "detect_isDeblendedSource", "detect_isPatchInner", "detect_isPrimary",
          "merge_peak_sky", "refExtendedness", "refSizeExtendedness",
        ]
        bands = parameters.bands_injected
        for band in bands:
          columns_ref_mag_to_nJy[f"{band}_mag"] = f"{band}_flux"
        for band in bands:
          for suffix in ("mag", "injection_flag"):
              columns_ref_copy.append(f"{band}_{suffix}")
          done_gaap = False
          for algo in parameters.flux_algorithms:
            is_gaap = algo.startswith("gaap")
            if not done_gaap and is_gaap:
              columns_target_copy.append(f"{band}_gaapFlux_flag")
              done_gaap = True
            suffixes = ["Flux", "FluxErr"]
            if is_gaap:
              suffixes.append("Flux_flag_bigPsf")
            elif algo == "cModel":
              suffixes.append("_flag")
            elif algo != "sersic":
              suffixes.append("Flux_flag")
            for suffix in suffixes:
              columns_target_copy.append(f"{band}_{algo}{suffix}")
        if "sersic" in parameters.flux_algorithms:
          columns_target_copy.extend([
            "sersic_x", "sersic_y", "sersic_xErr", "sersic_yErr",
            "sersic_ra", "sersic_dec", "sersic_raErr", "sersic_decErr",
            "sersic_index", "sersic_indexErr", "sersic_rho", "sersic_rhoErr",
            "sersic_reff_x", "sersic_reff_xErr", "sersic_reff_y", "sersic_reff_yErr",
            "sersic_unknown_flag", "sersic_no_data_flag",
          ])
        # TODO: Remove as part of DM-44139
        config.columns_ref_mag_to_nJy = columns_ref_mag_to_nJy
        config.columns_ref_copy = columns_ref_copy
        config.columns_target_copy = columns_target_copy
